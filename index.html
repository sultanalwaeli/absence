<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨ - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙŠØ¨</title>
<style>
/* â€”â€” Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ (Ø¨Ø¯Ù‘Ù„Øª Ù„Ø§ Ø´ÙŠØ¡) â€”â€” */
:root{ --brand:#115e59; --brand2:#0b8a6a; --ink:#0b1220; --muted:#5b6577; --stroke:#e6e9ef; --radius:16px; --bar:80px; --font-size:18px; --touch-target:44px; }
*{ box-sizing:border-box; } body{ margin:0; font-family:"Noto Naskh Arabic","Segoe UI",Tahoma,Arial,sans-serif; line-height:1.6; background:#0e1615; color:var(--ink); font-size:var(--font-size); -webkit-tap-highlight-color:transparent; }
.container{ max-width:100%; margin:0 auto; padding:12px 10px calc(var(--bar) + env(safe-area-inset-bottom) + 10px); }
.hero{ border-radius:18px; color:#fff; padding:14px; background:linear-gradient(135deg, rgba(17,94,89,.95), rgba(11,138,106,.95)); box-shadow:0 12px 30px rgba(0,0,0,.15); margin-bottom:12px; }
.hero-inner{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; }
.badge{ background:rgba(15,23,42,.9); color:#fff; border-radius:20px; padding:8px 12px; font-weight:700; font-size:14px; white-space:nowrap; }
.stats-comparison{ background:rgba(255,255,255,.1); border-radius:12px; padding:10px; margin-top:8px; font-size:13px; border:1px solid rgba(255,255,255,.2); }
.stats-comparison div{ margin-bottom:4px; }
.card{ background:#fff; border:1px solid var(--stroke); border-radius:var(--radius); padding:12px; margin-bottom:10px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
.grid2,.grid3{ display:grid; gap:8px; margin-bottom:8px; }
.grid2{ grid-template-columns:1fr 1fr; } .grid3{ grid-template-columns:1fr 1fr 1fr; }
@media (max-width:768px){ .grid3{ grid-template-columns:1fr; } .grid2{ grid-template-columns:1fr; } :root{ --font-size:16px; } }
.input,.select,.btn{ padding:14px; border:2px solid var(--stroke); border-radius:14px; background:#fff; font:inherit; font-size:var(--font-size); min-height:var(--touch-target); width:100%; }
.select{ appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235b6577' d='M6 8L2 4h8z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:left 14px center; background-size:12px; padding-left:40px; }
.btn{ border:none; font-weight:700; cursor:pointer; text-align:center; transition:all .2s ease; }
.btn:disabled{ opacity:.6; cursor:not-allowed; }
.primary{ color:#fff; background:linear-gradient(135deg, var(--brand), var(--brand2)); } .secondary{ background:#f8fafc; color:var(--ink); }
.danger{ color:#fff; background:#dc2626; } .warning{ color:#fff; background:linear-gradient(135deg, #f59e0b, #d97706); }
.sticky{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:2px solid var(--stroke); padding:10px; display:flex; gap:8px; z-index:1000; box-shadow:0 -8px 20px rgba(0,0,0,.1); flex-wrap:wrap; justify-content:space-between; }
.actions-group{ display:flex; gap:8px; flex-wrap:wrap; flex:1; } .actions-group .btn{ flex:1; min-width:120px; }
.name{ font-weight:700; font-size:var(--font-size); flex:1; } .meta{ color:#64748b; font-size:14px; }
.toast{ position:fixed; bottom:calc(var(--bar) + 80px); left:50%; transform:translateX(-50%); background:#0f172a; color:#fff; padding:16px 20px; border-radius:12px; display:none; z-index:1001; font-size:16px; max-width:90%; text-align:center; animation:toastSlide .3s ease-out; box-shadow:0 10px 25px rgba(0,0,0,.2); }
@keyframes toastSlide{ from{ transform:translateX(-50%) translateY(100px); opacity:0; } to{ transform:translateX(-50%) translateY(0); opacity:1; } }
.success-toast{ background:linear-gradient(135deg, #10b981, #059669); animation:successToast .5s ease-out; font-weight:bold; }
@keyframes successToast{ 0%{ transform:translateX(-50%) scale(.8); opacity:0; } 50%{ transform:translateX(-50%) scale(1.05); } 100%{ transform:translateX(-50%) scale(1); opacity:1; } }
.list{ max-height:50vh; overflow-y:auto; margin-top:8px; border:1px solid var(--stroke); border-radius:12px; transition:all .5s ease; }
.list.fade-out{ opacity:0; transform:translateY(-20px); max-height:0; overflow:hidden; }
.item{ display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid #f1f5f9; transition:all .3s ease; }
.item:last-child{ border-bottom:none; }
.item .tag{ font-size:12px; border-radius:20px; padding:4px 8px; border:1px solid var(--stroke); color:#475569; white-space:nowrap; }
input[type="checkbox"]{ transform:scale(1.3); margin:0; accent-color:var(--brand); }
.status-list{ display:flex; flex-wrap:wrap; gap:6px; }
.pill{ padding:8px 12px; border-radius:20px; border:2px solid var(--stroke); background:#fff; cursor:pointer; font-size:14px; transition:all .3s ease; }
.pill.taken{ background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#fff; border-color:transparent; animation:pulse 2s infinite; }
@keyframes pulse{ 0%{ transform:scale(1);} 50%{ transform:scale(1.05);} 100%{ transform:scale(1);} }
.small{ font-size:14px; color:#64748b; margin-top:6px; }
@media (max-width:480px){ .sticky{ padding:8px;} .actions-group{ gap:6px;} .actions-group .btn{ min-width:100px; font-size:14px; padding:10px;} }
.loading{ opacity:.7; pointer-events:none; }
.loading-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; justify-content:center; align-items:center; z-index:2000; }
.loading-spinner{ background:#fff; padding:30px; border-radius:16px; text-align:center; box-shadow:0 15px 35px rgba(0,0,0,.3); min-width:200px; }
.spinner{ border:4px solid #f3f3f3; border-top:4px solid var(--brand); border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 15px; }
@keyframes spin{ 0%{ transform:rotate(0);} 100%{ transform:rotate(360deg);} }
.empty-state{ text-align:center; padding:40px 20px; color:#64748b; transition:all .5s ease; font-size:16px; }
.empty-state.hidden{ display:none; }
.empty-state.success{ background:#f0fdf4; border:2px solid #bbf7d0; border-radius:12px; color:#15803d; animation:successMessage .6s ease-out; font-weight:bold; }
@keyframes successMessage{ 0%{ transform:scale(.9); opacity:0;} 50%{ transform:scale(1.02);} 100%{ transform:scale(1); opacity:1;} }
.instructions{ background:#f0f9ff; border:1px solid #bae6fd; border-radius:12px; padding:12px; margin-bottom:12px; font-size:14px; color:#0369a1; }
.instructions ul{ margin:8px 0; padding-right:20px; } .instructions li{ margin-bottom:4px; }
.comparison-card{ background:linear-gradient(135deg, #fef7ed, #fffbeb); border:2px solid #fed7aa; border-radius:var(--radius); padding:12px; margin-bottom:10px; }
.comparison-title{ font-weight:700; color:#ea580c; margin-bottom:8px; font-size:16px; }
.comparison-stats{ display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:14px; }
.stat-item{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #fed7aa; }
.stat-label{ color:#57534e; } .stat-value{ font-weight:700; }
.diff-positive{ color:#16a34a; } .diff-negative{ color:#dc2626; } .diff-zero{ color:#6b7280; }
.confetti{ position:fixed; width:10px; height:10px; background:#ffd700; border-radius:50%; animation:confetti-fall 3s ease-in-out forwards; z-index:1002; }
@keyframes confetti-fall{ 0%{ transform:translateY(-100px) rotate(0); opacity:1;} 100%{ transform:translateY(100vh) rotate(360deg); opacity:0;} }
.password-modal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; justify-content:center; align-items:center; z-index:3000; }
.password-content{ background:#fff; padding:30px; border-radius:20px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,.3); min-width:300px; max-width:90%; }
.password-content h3{ margin:0 0 20px; color:#dc2626; font-size:20px; }
.password-input{ width:100%; padding:15px; border:2px solid #e5e7eb; border-radius:12px; font-size:18px; text-align:center; margin-bottom:15px; font-family:monospace; letter-spacing:2px; }
.password-input:focus{ border-color:#dc2626; outline:none; }
.password-buttons{ display:flex; gap:10px; } .password-buttons button{ flex:1; padding:12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; }
.password-confirm{ background:#dc2626; color:#fff; } .password-cancel{ background:#6b7280; color:#fff; }
.grade-actions{ display:flex; gap:8px; margin-top:10px; } .grade-actions .btn{ flex:1; }
</style>
</head>
<body>
<div class="container">
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ -->
  <div id="passwordModal" class="password-modal">
    <div class="password-content">
      <h3>ğŸ”’ ØªÙØ±ÙŠØº Ø§Ù„ÙˆØ³ÙˆÙ…</h3>
      <p>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</p>
      <input type="password" id="passwordInput" class="password-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² 7211" maxlength="4">
      <div class="password-buttons">
        <button class="password-cancel" onclick="closePasswordModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="password-confirm" onclick="confirmClearMarks()">ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>

  <div class="hero">
    <div class="hero-inner">
      <div style="flex:1;min-width:200px">
        <div style="font-weight:700;font-size:20px;margin-bottom:6px">Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨</div>
        <div style="opacity:.9;font-size:14px">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ† ÙˆØ§Ø­ÙØ¸</div>
      </div>
      <div style="text-align:left">
        <span class="badge" id="statsBadge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        <div id="statsComparison" class="stats-comparison" style="display:none">
          <div id="comparisonText"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© -->
  <div id="comparisonCard" class="comparison-card" style="display:none">
    <div class="comparison-title">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</div>
    <div class="comparison-stats">
      <div class="stat-item"><span class="stat-label">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰:</span><span class="stat-value" id="morningAbsent">0 ØºØ§Ø¦Ø¨</span></div>
      <div class="stat-item"><span class="stat-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©:</span><span class="stat-value" id="emergencyAbsent">0 ØºØ§Ø¦Ø¨</span></div>
      <div class="stat-item"><span class="stat-label">Ø§Ù„ÙØ±Ù‚:</span><span class="stat-value" id="differenceAbsent">0</span></div>
      <div class="stat-item"><span class="stat-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span><span class="stat-value" id="differenceStatus">-</span></div>
    </div>
  </div>

  <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
  <div class="instructions">
    <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong>
    <ul>
      <li>Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ØªØ±ØªÙŠØ¨: Ø®Ø§Ù…Ø³ 1 â†’ Ø¹Ø§Ø´Ø± 4)</li>
      <li>Ø­Ø¯Ù‘Ø¯ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ† Ø«Ù… "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯"</li>
      <li>Ù„Ù„ØªØµØ­ÙŠØ­ Ø§Ø³ØªØ®Ø¯Ù… "ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„"</li>
    </ul>
  </div>

  <!-- Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙÙˆÙ -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px;font-size:16px">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙÙˆÙ</div>
    <div id="statusList" class="status-list"></div>
    <div class="small">Ø§Ù„Ø£Ø®Ø¶Ø± = ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</div>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
  <div class="card">
    <div class="grid3">
      <select id="mode" class="select">
        <option value="Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
        <option value="Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©">Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©</option>
      </select>

      <div>
        <select id="grade" class="select">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
        </select>
        <div id="gradeState" class="small">â€”</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:6px">
        <label style="display:flex;align-items:center;gap:8px;font-size:14px">
          <input type="checkbox" id="showAllAbs" />
          Ø¹Ø±Ø¶ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ† Ù„Ù„Ø¬Ù…ÙŠØ¹
        </label>
        <button class="btn secondary" id="showAbsentsBtn" type="button">Ø¹Ø±Ø¶ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</button>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙ -->
    <div id="gradeActions" class="grade-actions" style="display:none">
      <button class="btn primary" id="saveBulkBtn" type="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      <button class="btn warning" id="redoBtn" type="button">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    </div>

    <div class="grid2">
      <input id="q" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." />
      <div style="display:flex;flex-direction:column;gap:6px">
        <label style="display:flex;align-items:center;gap:8px;font-size:14px">
          <input type="checkbox" id="checkAll" />
          ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
        </label>
      </div>
    </div>

    <div id="list" class="list" style="display:none"></div>
    <div id="empty" class="empty-state">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...</div>

    <div id="absentsBox" class="card" style="margin-top:12px; display:none">
      <div style="font-weight:700">Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ† (<span id="absCount">0</span>)</div>
      <div id="absContent" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ -->
<div class="sticky">
  <div class="actions-group">
    <button class="btn danger" id="clearMarksBtn" type="button">ğŸ—‘ï¸ ØªÙØ±ÙŠØº Ø§Ù„ÙˆØ³ÙˆÙ…</button>
    <button class="btn secondary" id="refreshBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  </div>
  <div class="actions-group">
    <button class="btn secondary" id="clearSel" type="button">âŒ Ù…Ø³Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
    <button class="btn primary" id="focusSearch" type="button">ğŸ” Ø¨Ø­Ø«</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ==================== Ø¥Ø¹Ø¯Ø§Ø¯ API ==================== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyJPz3Gm0RcUrAVvQhy5sKXE2JpQ_5JHJQDdyxvx1XYhTWL4rHg5-78gm1sZAN8Cl3D/exec'; // â† Ø¶Ø¹ Ø±Ø§Ø¨Ø· Web App (GAS)
const API_KEY = ''; // Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø£Ø±Ø¯Øª ÙØ­Øµ Ù…ÙØªØ§Ø­ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±

// Ù†Ø³ØªØ®Ø¯Ù… form-urlencoded Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ø´Ø§ÙƒÙ„ CORS (simple request)
async function api(action, data = {}) {
  const params = new URLSearchParams();
  params.append('action', action);
  params.append('data', JSON.stringify({ action, ...data, key: API_KEY }));

  const res = await fetch(API_URL, { method: 'POST', body: params });
  // Ù‚Ø¯ ÙŠØ¹ÙŠØ¯ GAS Ø£Ø®Ø·Ø§Ø¡ HTML Ù…Ù† GoogleØ› Ù†Ø­Ø§ÙˆÙ„ parse Ø¨Ø£Ù…Ø§Ù†
  const text = await res.text();
  try { return JSON.parse(text); } catch { throw new Error('Bad JSON: ' + text.slice(0,120)); }
}

/* ==================== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© ==================== */
const qs = s => document.querySelector(s);
const qsa = s => document.querySelectorAll(s);
let CURRENT_LIST = [];
let CURRENT_FILTERED = [];
let SELECTED_ROWS = new Set();
let CURRENT_GRADE = '';

function playSuccessSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
    oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.2);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.3);
  } catch {}
}
function createConfetti() {
  try {
    const colors = ['#ffd700','#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#feca57'];
    for (let i=0;i<20;i++){
      const c = document.createElement('div');
      c.className='confetti'; c.style.left = Math.random()*100 + 'vw';
      c.style.background = colors[Math.floor(Math.random()*colors.length)];
      c.style.animationDelay = Math.random() * 1 + 's'; c.style.width='8px'; c.style.height='8px';
      document.body.appendChild(c); setTimeout(()=>c.remove(),3000);
    }
  } catch {}
}
const showToast = (msg, isSuccess=false) => {
  const toast = qs('#toast'); if (!toast) return;
  toast.textContent = msg; toast.className = isSuccess ? 'toast success-toast' : 'toast';
  toast.style.display = 'block'; toast.style.animation='none'; setTimeout(()=>{ toast.style.animation=''; },10);
  if (isSuccess){ playSuccessSound(); createConfetti(); }
  setTimeout(()=>{ toast.style.display='none'; }, 3000);
};
function showLoading(message='Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...'){
  const overlay = qs('#loadingOverlay'); overlay.querySelector('.loading-spinner div:last-child').textContent = message;
  overlay.style.display = 'flex'; document.body.classList.add('loading');
}
function hideLoading(){ qs('#loadingOverlay').style.display='none'; document.body.classList.remove('loading'); }

/* ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙˆØ§Ù„Ø¹Ø±Ø¶ ==================== */
function updateBadge(data) {
  if (!data) return;
  const cur = data.current || data;
  const t = cur.total ?? 0, a = cur.absent ?? 0, p = cur.present ?? (t - a);
  qs('#statsBadge').textContent = `${data.mode || '-'} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t} | ØºØ§Ø¦Ø¨: ${a} | Ø­Ø§Ø¶Ø±: ${p}`;
  updateComparison(data);
  if (data.statuses) renderStatuses(data.statuses);
}
function updateComparison(data) {
  const card = qs('#comparisonCard'); const panel = qs('#statsComparison');
  if (data.morning && data.emergency) {
    const m = data.morning.absent || 0, e = data.emergency.absent || 0, diff = m - e;
    qs('#morningAbsent').textContent   = `${m} ØºØ§Ø¦Ø¨`;
    qs('#emergencyAbsent').textContent = `${e} ØºØ§Ø¦Ø¨`;
    qs('#differenceAbsent').textContent = Math.abs(diff);
    qs('#differenceAbsent').className = `stat-value ${diff>0?'diff-positive':diff<0?'diff-negative':'diff-zero'}`;
    let statusText = diff>0 ? `Ø²ÙŠØ§Ø¯Ø© ${diff} ÙÙŠ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰` : diff<0 ? `Ø²ÙŠØ§Ø¯Ø© ${Math.abs(diff)} ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©` : 'Ù…ØªÙ…Ø§Ø«Ù„';
    qs('#differenceStatus').textContent = statusText;
    qs('#differenceStatus').className   = `stat-value ${diff>0?'diff-positive':diff<0?'diff-negative':'diff-zero'}`;
    card.style.display='block';
    qs('#comparisonText').textContent = data.comparison?.summary || `Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: ${m} | Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©: ${e} | Ø§Ù„ÙØ±Ù‚: ${diff}`;
    panel.style.display='block';
  }
}
function renderStatuses(statuses){
  const box = qs('#statusList'); box.innerHTML='';
  (statuses||[]).forEach(st=>{
    const pill = document.createElement('div');
    pill.className = 'pill' + (st.taken ? ' taken' : '');
    pill.innerHTML = (st.taken?'âœ…':'â³') + `<span>${st.grade}</span>`;
    pill.title = st.taken ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ' : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯';
    pill.addEventListener('click', ()=>{ qs('#grade').value = st.grade; onGradeChange(); });
    box.appendChild(pill);
  });
}

/* ==================== Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© ==================== */
function openPasswordModal(){ const m=qs('#passwordModal'); const i=qs('#passwordInput'); m.style.display='flex'; i.value=''; i.focus(); }
function closePasswordModal(){ qs('#passwordModal').style.display='none'; }

async function confirmClearMarks() {
  const password = qs('#passwordInput').value;
  if (!password) return showToast('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ');
  showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...');
  try {
    const check = await api('verifyPassword', { password });
    if (check.ok) { closePasswordModal(); await executeClearMarks(password); }
    else { showToast('âŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­'); qs('#passwordInput').value=''; qs('#passwordInput').focus(); }
  } catch { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚'); }
  finally { hideLoading(); }
}

async function executeClearMarks(password) {
  showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ³ÙˆÙ…...');
  try {
    const response = await api('clearAllMarks', { password });
    if (response.ok) {
      updateBadge(response);
      qs('#list').style.display='none'; const empty=qs('#empty');
      empty.style.display='block'; empty.textContent='Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...'; empty.className='empty-state';
      qs('#grade').value=''; qs('#gradeState').textContent='â€”'; qs('#gradeActions').style.display='none';
      SELECTED_ROWS.clear(); CURRENT_LIST=[]; CURRENT_FILTERED=[];
      showToast('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ³ÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­', true);
    } else { showToast('âŒ ' + response.message); }
  } catch { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ÙˆØ³ÙˆÙ…'); }
  finally { hideLoading(); }
}

function fadeOutListAndReset(grade){
  const list=qs('#list'); const empty=qs('#empty');
  if (!list) return;
  list.style.opacity='0'; list.style.transform='translateY(-20px)'; list.style.transition='all .5s ease';
  setTimeout(()=>{
    list.style.display='none';
    if (empty){
      empty.style.display='block'; empty.textContent='âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± ØµÙ Ø¢Ø®Ø±';
      empty.className='empty-state success'; empty.style.opacity='0'; empty.style.transform='scale(.8)';
      setTimeout(()=>{ empty.style.opacity='1'; empty.style.transform='scale(1)'; empty.style.transition='all .3s ease'; }, 100);
    }
    SELECTED_ROWS.clear(); const checkAll = qs('#checkAll'); if (checkAll) checkAll.checked=false;
    const q = qs('#q'); if (q) q.value='';
    CURRENT_LIST=[]; CURRENT_FILTERED=[]; updateSelectionCount();
  }, 500);
}

function updateSelectionCount(){
  const saveBtn=qs('#saveBulkBtn'), redoBtn=qs('#redoBtn');
  if (saveBtn){ const c=SELECTED_ROWS.size; saveBtn.textContent = c>0 ? `ğŸ’¾ Ø­ÙØ¸ (${c} ØºØ§Ø¦Ø¨)` : `ğŸ’¾ Ø­ÙØ¸ (Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±)`; }
  if (redoBtn){ const c=SELECTED_ROWS.size; redoBtn.textContent = c>0 ? `ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© (${c} ØºØ§Ø¦Ø¨)` : `ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© (Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±)`; }
}

async function onGradeChange(){
  const grade = qs('#grade').value; CURRENT_GRADE = grade;
  const actions = qs('#gradeActions'); actions.style.display = grade ? 'flex' : 'none';
  if (!grade){
    qs('#list').style.display='none'; const empty=qs('#empty'); empty.style.display='block';
    empty.textContent='Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...'; empty.className='empty-state'; qs('#gradeState').textContent='â€”'; return;
  }
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ...');
  qs('#empty').textContent='Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨...'; qs('#empty').className='empty-state';
  try {
    const res = await api('ensureBaselineOnGrade', { grade });
    updateBadge(res); await loadGradeListOnly();
  } catch { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ'); qs('#empty').textContent='Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'; }
  finally { hideLoading(); }
}

async function loadGradeListOnly(){
  const grade = qs('#grade').value; if (!grade) return;
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨...');
  try {
    const list = await api('getStudentsByGrade', { grade });
    CURRENT_LIST = Array.isArray(list) ? list : []; CURRENT_FILTERED = [...CURRENT_LIST];
    SELECTED_ROWS.clear(); qs('#checkAll').checked=false; renderList(); updateSelectionCount();
    const absentCount = CURRENT_LIST.filter(st => st.state === 'ØºØ§Ø¦Ø¨').length;
    qs('#gradeState').textContent = absentCount ? `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (${absentCount} ØºØ§Ø¦Ø¨)` : 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø¯';
  } catch { showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨'); }
  finally { hideLoading(); }
}

function renderList(){
  const list=qs('#list'), empty=qs('#empty'); list.innerHTML='';
  if (!CURRENT_FILTERED.length){ list.style.display='none'; empty.style.display='block'; empty.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬'; empty.className='empty-state'; return; }
  empty.style.display='none'; list.style.display='block'; list.style.opacity='1'; list.style.transform='none'; list.style.transition='none';
  CURRENT_FILTERED.forEach(st=>{
    const item=document.createElement('div'); item.className='item';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked = SELECTED_ROWS.has(st.row);
    cb.addEventListener('change', ()=>{ cb.checked ? SELECTED_ROWS.add(st.row) : SELECTED_ROWS.delete(st.row); updateSelectionCount(); });
    const info=document.createElement('div'); info.style.flex='1';
    const name=document.createElement('div'); name.className='name'; name.textContent=st.name;
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`Ø§Ù„ØµÙ: ${st.grade} - Ø§Ù„Ø±Ù‚Ù…: ${st.id}`;
    info.appendChild(name); info.appendChild(meta);
    const tag=document.createElement('span'); tag.className='tag';
    tag.textContent = st.state==='ØºØ§Ø¦Ø¨' ? 'ØºØ§Ø¦Ø¨' : 'Ø­Ø§Ø¶Ø±';
    tag.style.background = st.state==='ØºØ§Ø¦Ø¨' ? '#fee2e2' : '#d1fae5';
    tag.style.color     = st.state==='ØºØ§Ø¦Ø¨' ? '#dc2626' : '#065f46';
    tag.style.borderColor=st.state==='ØºØ§Ø¦Ø¨' ? '#fecaca' : '#a7f3d0';
    item.appendChild(cb); item.appendChild(info); item.appendChild(tag); list.appendChild(item);
  });
}

async function saveBulk(){
  const grade = qs('#grade')?.value; if (!grade) return showToast('âŒ Ø§Ø®ØªØ± ØµÙÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨...');
  const absentRows = Array.from(SELECTED_ROWS);
  try {
    const res = await api('smartMarkGrade', { grade, absentRows });
    if (res?.ok){
      const msg = absentRows.length ? `âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${res.presentCount||0} Ø­Ø§Ø¶Ø±, ${res.absentCount||0} ØºØ§Ø¦Ø¨`
                                    : `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ù„Ù„ØµÙ ÙƒØ§Ù…Ù„Ø§Ù‹ (${res.presentCount||0} Ø·Ø§Ù„Ø¨)`;
      showToast(msg, true); updateBadge(res); fadeOutListAndReset(grade);
    } else { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + (res?.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')); }
  } catch { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'); }
  finally { hideLoading(); }
}

async function redoAttendance(){
  const grade = qs('#grade')?.value; if (!grade) return showToast('âŒ Ø§Ø®ØªØ± ØµÙÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  if (!confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.')) return;
  showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„...');
  const absentRows = Array.from(SELECTED_ROWS);
  try {
    const res = await api('redoGradeAttendance', { grade, absentRows });
    if (res?.ok){
      const msg = absentRows.length ? `âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${res.presentCount||0} Ø­Ø§Ø¶Ø±, ${res.absentCount||0} ØºØ§Ø¦Ø¨`
                                    : `âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ù„Ù„ØµÙ ÙƒØ§Ù…Ù„Ø§Ù‹ (${res.presentCount||0} Ø·Ø§Ù„Ø¨)`;
      showToast(msg, true); updateBadge(res); fadeOutListAndReset(grade);
    } else { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + (res?.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')); }
  } catch { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„'); }
  finally { hideLoading(); }
}

function applyFilter(){
  const q = qs('#q'); const query = (q.value || '').toLowerCase().trim();
  CURRENT_FILTERED = !query ? [...CURRENT_LIST] :
    CURRENT_LIST.filter(s => s.name.toLowerCase().includes(query) || (s.id && s.id.toString().includes(query)));
  SELECTED_ROWS.clear(); qs('#checkAll').checked=false; renderList(); updateSelectionCount();
}

async function showAbsents(){
  const showAll = qs('#showAllAbs').checked;
  const box = qs('#absentsBox'); const content = qs('#absContent');
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†...');
  try{
    if (showAll){
      const res = await api('listAbsentsAll');
      content.innerHTML = ''; const total = res?.total ?? 0; qs('#absCount').textContent = total;
      if (!total){ content.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ.'; box.style.display='block'; return; }
      (res?.byGrade || []).forEach(g=>{
        const h=document.createElement('div'); h.style.fontWeight='700'; h.style.marginTop='12px'; h.textContent = `${g.grade} â€” (${g.count})`;
        const ul=document.createElement('ul'); ul.style.paddingRight='20px'; ul.style.marginTop='6px';
        g.names.forEach(s=>{ const li=document.createElement('li'); li.textContent = `${s.name} â€” Ø±Ù‚Ù…: ${s.id || '-'}`; li.style.marginBottom='4px'; ul.appendChild(li); });
        content.appendChild(h); content.appendChild(ul);
      });
      box.style.display='block';
    } else {
      const grade = qs('#grade').value; if (!grade){ showToast('âŒ Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø£ÙˆÙ„Ù‹Ø§ Ø£Ùˆ ÙØ¹Ù‘Ù„ "Ø¹Ø±Ø¶ Ù„Ù„Ø¬Ù…ÙŠØ¹"'); return; }
      const res = await api('listAbsents', { grade });
      content.innerHTML=''; const count = res?.count ?? 0; qs('#absCount').textContent = count;
      if (!count){ content.textContent = `Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ ÙÙŠ ØµÙ ${grade}.`; box.style.display='block'; return; }
      const ul=document.createElement('ul'); ul.style.paddingRight='20px'; ul.style.marginTop='6px';
      res.names.forEach(s=>{ const li=document.createElement('li'); li.textContent = `${s.name} â€” Ø±Ù‚Ù…: ${s.id || '-'}`; li.style.marginBottom='4px'; ul.appendChild(li); });
      content.appendChild(ul); box.style.display='block';
    }
  } catch { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†'); }
  finally { hideLoading(); }
}

/* ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ==================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
  try {
    const data = await api('getInitial');
    qs('#mode').value = data?.mode || 'Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰';
    const gradeSelect = qs('#grade');
    const grades = data?.grades || [];
    gradeSelect.innerHTML = '<option value=\"\">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>' + grades.map(g=>`<option value=\"${g}\">${g}</option>`).join('');
    renderStatuses(data?.statuses || []); updateBadge(data);
  } catch { showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„'); }
  finally { hideLoading(); }
});

/* ==================== Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ==================== */
qs('#mode').addEventListener('change', async e=>{
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ø±ØµØ¯...');
  try {
    const res = await api('setMode', { mode: e.target.value });
    updateBadge(res);
    if (qs('#grade').value) await loadGradeListOnly();
  } catch { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹'); }
  finally { hideLoading(); }
});
qs('#grade').addEventListener('change', onGradeChange);
qs('#q').addEventListener('input', applyFilter);
qs('#checkAll').addEventListener('change', e=>{
  const checked = e.target.checked;
  CURRENT_FILTERED.forEach(s=>{ checked ? SELECTED_ROWS.add(s.row) : SELECTED_ROWS.delete(s.row); });
  renderList(); updateSelectionCount();
});
qs('#saveBulkBtn').addEventListener('click', saveBulk);
qs('#redoBtn').addEventListener('click', redoAttendance);
qs('#showAbsentsBtn').addEventListener('click', showAbsents);
qs('#refreshBtn').addEventListener('click', async ()=>{
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª...');
  try { const data = await api('updateStats'); updateBadge(data); } finally { hideLoading(); }
});
qs('#clearMarksBtn').addEventListener('click', openPasswordModal);
qs('#clearSel').addEventListener('click', ()=>{ SELECTED_ROWS.clear(); qs('#checkAll').checked=false; renderList(); updateSelectionCount(); });
qs('#focusSearch').addEventListener('click', ()=>{ qs('#q').focus(); });

// Enter Ù„Ù„ØªØ£ÙƒÙŠØ¯ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ù…Ø²
document.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && qs('#passwordModal').style.display==='flex'){ confirmClearMarks(); } });
</script>
</body>
</html>
