<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>ุฑุตุฏ ุงูุบูุงุจ - ุชุทุจูู ุงูููุจ</title>
<style>
:root{
  --brand:#115e59; --brand2:#0b8a6a; --ink:#0b1220; --muted:#5b6577; --stroke:#e6e9ef;
  --radius:16px; --bar:84px; --font:17px; --touch:44px;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Naskh Arabic","Segoe UI",Tahoma,Arial,sans-serif;line-height:1.6;background:#0e1615;color:#0b1220;font-size:var(--font);-webkit-tap-highlight-color:transparent}
.container{max-width:100%;margin:0 auto;padding:12px 10px calc(var(--bar) + env(safe-area-inset-bottom) + 10px)}
.hero{border-radius:18px;color:#fff;padding:14px;background:linear-gradient(135deg,rgba(17,94,89,.96),rgba(11,138,106,.96));box-shadow:0 12px 30px rgba(0,0,0,.15);margin-bottom:12px}
.hero-inner{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap}
.badge{background:rgba(15,23,42,.92);color:#fff;border-radius:20px;padding:8px 12px;font-weight:700;font-size:14px;white-space:nowrap}
.card{background:#fff;border:1px solid var(--stroke);border-radius:var(--radius);padding:12px;margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.grid2,.grid3{display:grid;gap:8px;margin-bottom:8px}
.grid2{grid-template-columns:1fr 1fr}
.grid3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:768px){.grid3{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}:root{--font:16px}}
.input,.select,.btn{padding:14px;border:2px solid var(--stroke);border-radius:14px;background:#fff;font:inherit;font-size:var(--font);min-height:var(--touch);width:100%}
.select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235b6577' d='M6 8L2 4h8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:left 14px center;background-size:12px;padding-left:40px}
.btn{border:none;font-weight:700;cursor:pointer;text-align:center;transition:.2s}
.btn:disabled{opacity:.6;cursor:not-allowed}
.primary{color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand2))}
.secondary{background:#f8fafc;color:var(--ink)}
.warning{color:#fff;background:linear-gradient(135deg,#f59e0b,#d97706)}
.danger{color:#fff;background:#dc2626}
.small{font-size:13px;color:#64748b}
.list{max-height:50vh;overflow-y:auto;margin-top:8px;border:1px solid var(--stroke);border-radius:12px}
.item{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid #f1f5f9}
.item:last-child{border-bottom:none}
.item .tag{font-size:12px;border-radius:20px;padding:4px 8px;border:1px solid var(--stroke);white-space:nowrap}
input[type="checkbox"]{transform:scale(1.25);accent-color:var(--brand);margin:0}
.status-list{display:flex;flex-wrap:wrap;gap:6px}
.pill{padding:8px 12px;border-radius:20px;border:2px solid var(--stroke);background:#fff;cursor:pointer;font-size:14px;transition:.2s}
.pill.taken{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
.sticky{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:2px solid var(--stroke);padding:10px;display:flex;gap:8px;z-index:1000;box-shadow:0 -8px 20px rgba(0,0,0,.1);flex-wrap:wrap;justify-content:space-between}
.actions{display:flex;gap:8px;flex-wrap:wrap;flex:1}
.toast{position:fixed;bottom:calc(var(--bar)+76px);left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;padding:14px 18px;border-radius:12px;display:none;z-index:1001;font-size:15px;max-width:94%;text-align:center}
.success{background:linear-gradient(135deg,#10b981,#059669);font-weight:bold}
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1200}
.loading-box{background:#fff;padding:26px;border-radius:14px;min-width:220px;box-shadow:0 15px 35px rgba(0,0,0,.3);text-align:center}
.spinner{border:4px solid #eee;border-top:4px solid var(--brand);border-radius:50%;width:46px;height:46px;animation:spin 1s linear infinite;margin:0 auto 12px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.instructions{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:12px;margin-bottom:12px;font-size:14px;color:#0369a1}
.progress{display:flex;gap:8px;margin-top:8px}
.kpi{flex:1;background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:10px;text-align:center}
.kpi .v{font-weight:800;font-size:18px}
.kpi .t{font-size:12px;color:#64748b}
.bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:8px}
.bar > div{height:100%;background:linear-gradient(90deg,#10b981,#0ea5e9)}
.password-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:1300}
.password-content{background:#fff;padding:30px;border-radius:18px;min-width:300px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,.35)}
.password-content h3{margin:0 0 10px 0;color:#dc2626;font-size:19px}
.password-input{width:100%;padding:14px;border:2px solid #e5e7eb;border-radius:12px;font-size:18px;text-align:center;margin-bottom:12px;font-family:monospace;letter-spacing:2px}
.password-actions{display:flex;gap:8px}
.password-actions button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
.password-confirm{background:#dc2626;color:#fff}
.password-cancel{background:#6b7280;color:#fff}
</style>
</head>
<body>
<div class="container">

  <!-- Overlay -->
  <div id="loading" class="loading-overlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <div id="loadingMsg">ุฌุงุฑู ุงูุชุญูููโฆ</div>
    </div>
  </div>

  <!-- Password modal -->
  <div id="pwModal" class="password-modal">
    <div class="password-content">
      <h3>๐ ุชูุฑูุบ ุงููุณูู</h3>
      <p class="small">ุฃุฏุฎู ุงูุฑูุฒ ุงูุณุฑู ูููุชุงุจุนุฉ</p>
      <input id="pwInput" type="password" maxlength="4" class="password-input" placeholder="****">
      <div class="password-actions">
        <button class="password-cancel" onclick="closePw()">ุฅูุบุงุก</button>
        <button class="password-confirm" onclick="confirmClear()">ุชุฃููุฏ</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="hero">
    <div class="hero-inner">
      <div style="flex:1;min-width:220px">
        <div style="font-weight:800;font-size:20px;margin-bottom:6px">ุฑุตุฏ ุงูุบูุงุจ</div>
        <div class="small" style="opacity:.95">ุงุฎุชุฑ ุงูุตู โ ุนูููู ุงูุบุงุฆุจูู โ ุงุญูุธ. ุงูุฑูู ุงูุธุงูุฑ ูู <b>ุฑูู ูููู ุงูุฃูุฑ</b>.</div>
        <div class="progress">
          <div class="kpi">
            <div id="kpiTotal" class="v">0</div><div class="t">ุงูุฅุฌูุงูู</div>
          </div>
          <div class="kpi">
            <div id="kpiPresent" class="v">0 (0%)</div><div class="t">ุญุถูุฑ</div>
            <div class="bar"><div id="barPresent" style="width:0%"></div></div>
          </div>
          <div class="kpi">
            <div id="kpiAbsent" class="v">0 (0%)</div><div class="t">ุบูุงุจ</div>
            <div class="bar"><div id="barAbsent" style="width:0%;background:linear-gradient(90deg,#f97316,#ef4444)"></div></div>
          </div>
        </div>
      </div>
      <div style="text-align:left">
        <span id="badge" class="badge">โฆ</span>
      </div>
    </div>
  </div>

  <!-- ุชุนูููุงุช ุณุฑูุนุฉ -->
  <div class="instructions">
    <b>ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู ุงูุณุฑูุนุฉ:</b>
    <ul>
      <li>ุงุฎุชุฑ <b>ุงููุถุน</b> (ุงูุญุตุฉ ุงูุฃููู / ุญุงูุฉ ุทุงุฑุฆุฉ) ุซู ุงุฎุชุฑ <b>ุงูุตู</b>.</li>
      <li>ุญุฏุฏ ุงูุบุงุฆุจูู ููุท ุซู ุงุถุบุท <b>๐พ ุญูุธ</b> (ููุณุฌู ุญุถูุฑ ููุจุงููู ุชููุงุฆููุง).</li>
      <li>ูุนูู ุฎูุงุฑ <b>ุฅุฑุณุงู ุชููุงุฆู</b> ูุฅุฑุณุงู ุฑุณุงูุฉ ููููู ุงูุฃูุฑ ููุฑ ุงูุญูุธ (SMS/WhatsApp).</li>
      <li>ุฒุฑ <b>๐ ุฅุนุงุฏุฉ ุงูุชุณุฌูู</b> ููุณุญ ุชุณุฌูู ุงูุตู ุซู ูุนูุฏ ุงูุญูุธ ุจุงูุตุญูุญ.</li>
    </ul>
  </div>

  <!-- ูุชุงุจุนุฉ ุงูุตููู -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">ูุชุงุจุนุฉ ุงูุตููู</div>
    <div id="statusList" class="status-list"></div>
    <div class="small">ุงูุฃุฎุถุฑ = ุชู ุชุณุฌูู ุงูุบูุงุจ ููุฐุง ุงูุตู.</div>
  </div>

  <!-- ุฃุฏูุงุช -->
  <div class="card">
    <div class="grid3">
      <select id="mode" class="select">
        <option value="ุงูุญุตุฉ ุงูุฃููู">ุงูุญุตุฉ ุงูุฃููู</option>
        <option value="ุญุงูุฉ ุทุงุฑุฆุฉ">ุญุงูุฉ ุทุงุฑุฆุฉ</option>
      </select>

      <div>
        <select id="grade" class="select"><option value="">ุงุฎุชุฑ ุงูุตู</option></select>
        <div id="gradeState" class="small">โ</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:6px">
        <label class="small" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="showAll"> ุนุฑุถ ุงูุบุงุฆุจูู ููุฌููุน
        </label>
        <button id="btnShowAbs" class="btn secondary" type="button">ุนุฑุถ ุงูุบุงุฆุจูู</button>
      </div>
    </div>

    <!-- ุตูุญุฉ ุงูุตู -->
    <div id="gradeActions" class="grid2" style="display:none;margin-top:6px">
      <button id="btnSave" class="btn primary" type="button">๐พ ุญูุธ ุงูุบูุงุจ ุงููุญุฏุฏ</button>
      <button id="btnRedo" class="btn warning" type="button">๐ ุฅุนุงุฏุฉ ุงูุชุณุฌูู</button>
    </div>

    <div class="grid2" style="margin-top:8px">
      <input id="q" class="input" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ูููู ุงูุฃูุฑโฆ">
      <label class="small" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="checkAll"> ุชุญุฏูุฏ/ุฅูุบุงุก ุงููู
      </label>
    </div>

    <!-- ูุงูุจ ุงูุฅุดุนุงุฑ + ุงูุชุญูู ูู ุงูููุงุฉ -->
    <div class="grid2" style="margin-top:6px">
      <div>
        <textarea id="smsTemplate" class="input" rows="2" placeholder="ูุงูุจ ุฑุณุงูุฉ ูููู ุงูุฃูุฑโฆ (ูุซุงู: ูุญูุทูู ุนูููุง ุจุบูุงุจ ุงุจููู ุงูููู. ูุฃูู ุงููุชุงุจุนุฉ)"></textarea>
        <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
          <label class="small" style="display:flex;align-items:center;gap:6px">
            ุงูููุงุฉ:
            <select id="channel" class="select" style="padding:6px 10px;width:auto">
              <option value="sms">SMS</option>
              <option value="whatsapp">WhatsApp</option>
            </select>
          </label>
          <label class="small" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="autoNotify" checked> ุฅุฑุณุงู ุชููุงุฆู ุจุนุฏ ุงูุญูุธ
          </label>
        </div>
      </div>
      <button id="notifyAllBtn" class="btn secondary" type="button">๐ข ุฅุฑุณุงู ุฌูุงุนู ูุบููุงุจ ุงูุตู</button>
    </div>

    <!-- ุงููุงุฆูุฉ -->
    <div id="list" class="list" style="display:none"></div>
    <div id="empty" class="small" style="text-align:center;padding:28px;color:#64748b">ุงุฎุชุฑ ุงูุตู ูุชุญููู ุงูุฃุณูุงุกโฆ</div>

    <!-- ุงูุบุงุฆุจูู -->
    <div id="absBox" class="card" style="display:none;margin-top:10px">
      <div style="font-weight:700">ุงูุบุงุฆุจูู (<span id="absCount">0</span>)</div>
      <div id="absContent" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- ุดุฑูุท ุณููู -->
<div class="sticky">
  <div class="actions">
    <button id="btnClearAll" class="btn danger" type="button">๐๏ธ ุชูุฑูุบ ุงููุณูู</button>
    <button id="btnRefresh"  class="btn secondary" type="button">๐ ุชุญุฏูุซ</button>
  </div>
  <div class="actions">
    <button id="btnClearSel" class="btn secondary" type="button">โ ูุณุญ ุงูุชุญุฏูุฏ</button>
    <button id="btnFocus"    class="btn primary"   type="button">๐ ุจุญุซ</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ============ ุฃุฏูุงุช ุตุบูุฑุฉ ============ */
const qs=s=>document.querySelector(s), qsa=s=>document.querySelectorAll(s);
const toast=(m,ok=false)=>{const t=qs('#toast');t.textContent=m;t.className='toast'+(ok?' success':'');t.style.display='block';setTimeout(()=>t.style.display='none',2600)}
const showLoad=(m='ุฌุงุฑู ุงูุชุญูููโฆ')=>{qs('#loadingMsg').textContent=m;qs('#loading').style.display='flex'}
const hideLoad=()=>qs('#loading').style.display='none'

/* ============ ุญุงูุฉ ูุงุฌูุฉ ============ */
let CURRENT=[], FILTERED=[], SELECTED=new Set();

/* ============ ุฑุณููุงุช ============ */
function kpi(stats){
  const t=stats?.current?.total||0, a=stats?.current?.absent||0, p=Math.max(0,t-a);
  const pp=t?Math.round((p/t)*100):0, pa=t?Math.round((a/t)*100):0;
  qs('#kpiTotal').textContent=t;
  qs('#kpiPresent').textContent=`${p} (${pp}%)`;
  qs('#kpiAbsent').textContent=`${a} (${pa}%)`;
  qs('#barPresent').style.width=pp+'%';
  qs('#barAbsent').style.width=pa+'%';
}

function updateHeader(data){
  if(!data) return;
  const cur=data.current||{};
  const t=cur.total||0, a=cur.absent||0, p=cur.present??(t-a);
  qs('#badge').textContent=`${data.mode||'-'} | ุงูุฅุฌูุงูู: ${t} | ุบุงุฆุจ: ${a} | ุญุงุถุฑ: ${p}`;
  if(data.statuses) renderStatuses(data.statuses);
  kpi(data);
}

/* ============ ุชุญููู ุงูุญุงูุฉ ุงูุฃูููุฉ ============ */
document.addEventListener('DOMContentLoaded', ()=>{
  showLoad('ุฌุงุฑู ุชุญููู ุงูุชุทุจููโฆ');
  google.script.run.withSuccessHandler(d=>{
    qs('#mode').value=d?.mode||'ุงูุญุตุฉ ุงูุฃููู';
    const sel=qs('#grade');
    const grades=d?.grades||[];
    sel.innerHTML='<option value="">ุงุฎุชุฑ ุงูุตู</option>'+grades.map(g=>`<option>${g}</option>`).join('');
    renderStatuses(d?.statuses||[]);
    updateHeader(d);
    hideLoad();
  }).withFailureHandler(_=>{toast('ุฎุทุฃ ูู ุงูุชุญููู');hideLoad()}).getInitial();
});

/* ============ ูุชุงุจุนุฉ ุงูุตููู ============ */
function renderStatuses(statuses){
  const box=qs('#statusList'); box.innerHTML='';
  statuses.forEach(st=>{
    const pill=document.createElement('div');
    pill.className='pill'+(st.taken?' taken':'');
    pill.title=st.taken?'ุชู ุงูุชุณุฌูู':'ูู ูุชู ุงูุชุณุฌูู';
    pill.textContent=st.grade;
    pill.onclick=()=>{qs('#grade').value=st.grade; onGradeChange()}
    box.appendChild(pill);
  })
}

/* ============ ุชุบููุฑ ุงููุถุน ============ */
qs('#mode').addEventListener('change', e=>{
  showLoad('ุชุบููุฑ ุงููุถุนโฆ');
  google.script.run.withSuccessHandler(res=>{
    updateHeader(res);
    if(qs('#grade').value){ loadGradeList() } else { hideLoad() }
  }).withFailureHandler(_=>{toast('ุชุนุฐูุฑ ุชุบููุฑ ุงููุถุน');hideLoad()}).setMode(e.target.value);
});

/* ============ ุชุบููุฑ ุงูุตู ============ */
qs('#grade').addEventListener('change', onGradeChange);
function onGradeChange(){
  const g=qs('#grade').value;
  const actions=qs('#gradeActions');
  actions.style.display=g?'grid':'none';
  if(!g){qs('#list').style.display='none';qs('#empty').textContent='ุงุฎุชุฑ ุงูุตู ูุชุญููู ุงูุฃุณูุงุกโฆ';return;}
  showLoad('ุชุญููู ุจูุงูุงุช ุงูุตูโฆ');
  google.script.run.withSuccessHandler(res=>{
    updateHeader(res); loadGradeList();
  }).withFailureHandler(_=>{toast('ุชุนุฐูุฑ ุชุญููู ุงูุตู');hideLoad()}).ensureBaselineOnGrade(g);
}

function loadGradeList(){
  const g=qs('#grade').value; if(!g) return;
  google.script.run.withSuccessHandler(list=>{
    CURRENT=Array.isArray(list)?list:[];
    FILTERED=[...CURRENT]; SELECTED.clear(); qs('#checkAll').checked=false;
    renderList(); updateSelButtons(); hideLoad();
    const abs=CURRENT.filter(s=>s.state==='ุบุงุฆุจ').length;
    qs('#gradeState').textContent=abs>0?`ุชู ุชุณุฌูู ุงูุบูุงุจ ุณุงุจููุง (${abs} ุบุงุฆุจ)`:'ูู ูุชู ุชุณุฌูู ุงูุบูุงุจ ุจุนุฏ';
  }).withFailureHandler(_=>{toast('ุฎุทุฃ ูู ุชุญููู ุงูุฃุณูุงุก');hideLoad()}).getStudentsByGrade(g);
}

/* ============ ูุงุฆูุฉ ุงูุทูุงุจ ============ */
function renderList(){
  const list=qs('#list'), empty=qs('#empty'); list.innerHTML='';
  if(!FILTERED.length){list.style.display='none';empty.style.display='block';empty.textContent='ูุง ุชูุฌุฏ ูุชุงุฆุฌ';return;}
  empty.style.display='none'; list.style.display='block';
  FILTERED.forEach(st=>{
    const row=document.createElement('div'); row.className='item';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=SELECTED.has(st.row);
    cb.onchange=()=>{cb.checked?SELECTED.add(st.row):SELECTED.delete(st.row); updateSelButtons();}
    const info=document.createElement('div'); info.style.flex='1';
    info.innerHTML=`<div style="font-weight:700">${st.name}</div><div class="small">ุงูุตู: ${st.grade} โ ูุงุชู ูููู ุงูุฃูุฑ: ${st.id||'-'}</div>`;
    const tag=document.createElement('span'); tag.className='tag'; tag.textContent= st.state==='ุบุงุฆุจ'?'ุบุงุฆุจ':'ุญุงุถุฑ';
    const absent = st.state==='ุบุงุฆุจ';
    tag.style.background=absent?'#fee2e2':'#d1fae5'; tag.style.color=absent?'#dc2626':'#065f46'; tag.style.borderColor=absent?'#fecaca':'#a7f3d0';
    row.append(cb,info,tag); list.appendChild(row);
  })
}
function updateSelButtons(){
  const n=SELECTED.size;
  qs('#btnSave').textContent = n?`๐พ ุญูุธ (${n} ุบุงุฆุจ)`: '๐พ ุญูุธ (ุงููู ุญุงุถุฑ)';
  qs('#btnRedo').textContent = n?`๐ ุฅุนุงุฏุฉ (${n} ุบุงุฆุจ)`: '๐ ุฅุนุงุฏุฉ (ุงููู ุญุงุถุฑ)';
}

/* ============ ุจุญุซ ูุชุญุฏูุฏ ============ */
qs('#q').addEventListener('input', ()=>{
  const q=qs('#q').value.trim().toLowerCase();
  FILTERED= q? CURRENT.filter(s=> (s.name||'').toLowerCase().includes(q) || String(s.id||'').includes(q)) : [...CURRENT];
  SELECTED.clear(); qs('#checkAll').checked=false; renderList(); updateSelButtons();
});
qs('#checkAll').addEventListener('change', e=>{
  const ck=e.target.checked; (FILTERED||[]).forEach(s=>{ if(ck) SELECTED.add(s.row); else SELECTED.delete(s.row) });
  renderList(); updateSelButtons();
});

/* ============ ุญูุธ/ุฅุนุงุฏุฉ ============ */
qs('#btnSave').addEventListener('click', save);
function save(){
  const g=qs('#grade').value; if(!g) return toast('ุงุฎุชุฑ ุตููุง ุฃูููุง');
  const rows=[...SELECTED];
  showLoad('ุชุณุฌูู ุงูุบูุงุจโฆ');
  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){
      toast(`ุชู: ${res.presentCount||0} ุญุงุถุฑ | ${res.absentCount||0} ุบุงุฆุจ`,true);
      updateHeader(res);
      // ุฅุดุนุงุฑ ุชููุงุฆู
      const auto=qs('#autoNotify').checked, body=(qs('#smsTemplate').value||'').trim() || 'ูุญูุทูู ุนูููุง ุจุบูุงุจ ุงุจููู ุงูููู. ูุฃูู ุงููุชุงุจุนุฉ.', channel=qs('#channel').value||'sms';
      if(auto && rows.length){
        google.script.run.withSuccessHandler(r=>{
          if(r?.ok){ const ok=(r.results||[]).filter(x=>x.ok).length; toast(`ุฃูุฑุณูุช ${ok}/${r.count} ุฑุณุงูุฉ`,true); }
        }).notifyOnMark(g, rows, body, channel);
      }
      // ุชูุธูู
      CURRENT=[]; FILTERED=[]; SELECTED.clear(); qs('#list').style.display='none'; qs('#empty').style.display='block'; qs('#empty').textContent='โ ุชู ุงูุญูุธ. ุงุฎุชุฑ ุตููุง ุขุฎุฑ.';
    }else{ toast('ุญุฏุซ ุฎุทุฃ ูู ุงูุญูุธ'); }
    hideLoad();
  }).withFailureHandler(_=>{toast('ุชุนุฐูุฑ ุงูุญูุธ');hideLoad()}).smartMarkGrade(g, rows);
}

qs('#btnRedo').addEventListener('click', ()=>{
  const g=qs('#grade').value; if(!g) return toast('ุงุฎุชุฑ ุตููุง ุฃูููุง');
  if(!confirm('ุณูุชู ูุณุญ ุชุณุฌูู ุงูุตู ุซู ุฅุนุงุฏุฉ ุงูุชุณุฌูู ููู ุงูุชุญุฏูุฏ ุงูุญุงูู. ูุชุงุจุนุฉุ')) return;
  const rows=[...SELECTED]; showLoad('ุฅุนุงุฏุฉ ุงูุชุณุฌููโฆ');
  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){
      toast(`ุชูุช ุงูุฅุนุงุฏุฉ: ${res.presentCount||0} ุญุงุถุฑ | ${res.absentCount||0} ุบุงุฆุจ`,true);
      updateHeader(res);
      const auto=qs('#autoNotify').checked, body=(qs('#smsTemplate').value||'').trim() || 'ูุญูุทูู ุนูููุง ุจุบูุงุจ ุงุจููู ุงูููู. ูุฃูู ุงููุชุงุจุนุฉ.', channel=qs('#channel').value||'sms';
      if(auto && rows.length){
        google.script.run.withSuccessHandler(r=>{
          if(r?.ok){ const ok=(r.results||[]).filter(x=>x.ok).length; toast(`ุฃูุฑุณูุช ${ok}/${r.count} ุฑุณุงูุฉ`,true); }
        }).notifyOnMark(g, rows, body, channel);
      }
      CURRENT=[]; FILTERED=[]; SELECTED.clear(); qs('#list').style.display='none'; qs('#empty').style.display='block'; qs('#empty').textContent='โ ุชูุช ุงูุฅุนุงุฏุฉ. ุงุฎุชุฑ ุตููุง ุขุฎุฑ.';
    }else{ toast('ุชุนุฐูุฑ ุฅุนุงุฏุฉ ุงูุชุณุฌูู'); }
    hideLoad();
  }).withFailureHandler(_=>{toast('ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุงูุชุณุฌูู');hideLoad()}).redoGradeAttendance(g, rows);
});

/* ============ ุงูุบุงุฆุจูู ============ */
qs('#btnShowAbs').addEventListener('click', ()=>{
  const all=qs('#showAll').checked, box=qs('#absBox'), content=qs('#absContent'); showLoad('ุชุญููู ุงูุบุงุฆุจููโฆ');
  if(all){
    google.script.run.withSuccessHandler(res=>{
      const total=res?.total||0; qs('#absCount').textContent=total; content.innerHTML='';
      if(!total){content.textContent='ูุง ููุฌุฏ ุบูุงุจ ูู ุฌููุน ุงูุตููู.'; box.style.display='block'; return hideLoad();}
      (res?.byGrade||[]).forEach(g=>{
        const h=document.createElement('div'); h.style.fontWeight='700'; h.style.marginTop='10px'; h.textContent=`${g.grade} โ (${g.count})`; content.appendChild(h);
        const ul=document.createElement('ul'); ul.style.paddingRight='20px'; g.names.forEach(s=>{const li=document.createElement('li'); li.textContent=`${s.name} โ ูุงุชู ูููู ุงูุฃูุฑ: ${s.id||'-'}`; ul.appendChild(li)}); content.appendChild(ul);
      }); box.style.display='block'; hideLoad();
    }).listAbsentsAll();
  }else{
    const g=qs('#grade').value; if(!g){toast('ุงุฎุชุฑ ุงูุตู ุฃูููุง ุฃู ูุนูู "ุนุฑุถ ููุฌููุน"'); return hideLoad();}
    google.script.run.withSuccessHandler(res=>{
      const c=res?.count||0; qs('#absCount').textContent=c; content.innerHTML='';
      if(!c){content.textContent=`ูุง ููุฌุฏ ุบูุงุจ ูู ุตู ${g}.`; box.style.display='block'; return hideLoad();}
      const ul=document.createElement('ul'); ul.style.paddingRight='20px';
      (res.names||[]).forEach(s=>{const li=document.createElement('li'); li.textContent=`${s.name} โ ูุงุชู ูููู ุงูุฃูุฑ: ${s.id||'-'}`; ul.appendChild(li)});
      content.appendChild(ul); box.style.display='block'; hideLoad();
    }).listAbsents(g);
  }
});

/* ============ ุฅุฌุฑุงุกุงุช ุนุงูุฉ ============ */
qs('#btnRefresh').addEventListener('click', ()=>{showLoad('ุชุญุฏูุซ ุงูุฅุญุตุงุกุงุชโฆ'); google.script.run.withSuccessHandler(d=>{updateHeader(d); hideLoad()}).withFailureHandler(_=>hideLoad()).updateStats()});
qs('#btnClearSel').addEventListener('click', ()=>{SELECTED.clear(); qs('#checkAll').checked=false; renderList(); updateSelButtons()});
qs('#btnFocus').addEventListener('click', ()=>qs('#q').focus());

/* ============ ุชูุฑูุบ ุงููุณูู ุจุฑูุฒ ============ */
qs('#btnClearAll').addEventListener('click', ()=>{qs('#pwInput').value=''; qs('#pwModal').style.display='flex'; setTimeout(()=>qs('#pwInput').focus(),50)});
function closePw(){qs('#pwModal').style.display='none'}
function confirmClear(){
  const pass=qs('#pwInput').value||''; if(!pass) return toast('ุงุฏุฎู ุงูุฑูุฒ ุงูุณุฑู');
  showLoad('ุงูุชุญูู ูู ุงูุฑูุฒโฆ');
  google.script.run.withSuccessHandler(v=>{
    if(!v.ok){toast('ุงูุฑูุฒ ุบูุฑ ุตุญูุญ'); hideLoad(); return;}
    showLoad('ุชูุฑูุบ ุงููุณููโฆ');
    google.script.run.withSuccessHandler(r=>{
      closePw();
      if(r.ok){
        updateHeader(r);
        qs('#list').style.display='none'; qs('#empty').style.display='block'; qs('#empty').textContent='ุชู ุงูุชูุฑูุบ. ุงุฎุชุฑ ุตููุง ูุจุฏุก ุงูุฑุตุฏ.';
        toast('ุชู ูุณุญ ุฌููุน ุงููุณูู',true);
      }else{toast('ุชุนุฐูุฑ ุงูุชูุฑูุบ')}
      hideLoad();
    }).clearAllMarks(pass);
  }).withFailureHandler(_=>{toast('ุฎุทุฃ ูู ุงูุชุญูู');hideLoad()}).verifyPassword(pass);
}
qs('#pwInput').addEventListener('keypress',e=>{if(e.key==='Enter') confirmClear()});

/* ============ ุฅุฑุณุงู ุฌูุงุนู ูุฏูู ============ */
qs('#notifyAllBtn').addEventListener('click', ()=>{
  const g=qs('#grade').value; if(!g) return toast('ุงุฎุชุฑ ุงูุตู ุฃูููุง');
  // ูุฃุชู ุจุบูุงุจ ุงูุตู ุงูุญุงูู ุซู ูุฑุณู ููู
  showLoad('ุชุญุถูุฑ ุงูุฅุฑุณุงู ุงูุฌูุงุนูโฆ');
  google.script.run.withSuccessHandler(res=>{
    const rows=(res||[]).filter(s=>s.state==='ุบุงุฆุจ').map(s=>s.row);
    const body=(qs('#smsTemplate').value||'').trim() || 'ูุญูุทูู ุนูููุง ุจุบูุงุจ ุงุจููู ุงูููู. ูุฃูู ุงููุชุงุจุนุฉ.';
    const channel=qs('#channel').value||'sms';
    if(!rows.length){toast('ูุง ููุฌุฏ ุบูุงุจ ูู ูุฐุง ุงูุตู'); return hideLoad();}
    google.script.run.withSuccessHandler(r=>{
      if(r?.ok){const ok=(r.results||[]).filter(x=>x.ok).length; toast(`ุฃูุฑุณูุช ${ok}/${r.count} ุฑุณุงูุฉ`,true)}
      hideLoad();
    }).notifyOnMark(g, rows, body, channel);
  }).withFailureHandler(_=>{toast('ุชุนุฐูุฑ ุฌูุจ ูุงุฆูุฉ ุงูุตู');hideLoad()}).getStudentsByGrade(g);
});
</script>
</body>
</html>

