<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>نظام رصد الغياب</title>
<style>
body{font-family:"Noto Naskh Arabic",sans-serif;background:#f4f6f8;color:#222;margin:0;padding:20px}
.container{max-width:900px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px}
h1{text-align:center;color:#0b806a}
button,select,textarea{font-family:inherit;font-size:16px}
button{cursor:pointer;padding:10px 20px;border:none;border-radius:10px}
button.primary{background:#0b806a;color:#fff}
button.secondary{background:#eee}
textarea{width:100%;border:1px solid #ddd;border-radius:10px;padding:10px}
select{padding:10px;border-radius:8px;border:1px solid #ccc;width:100%}
.list{margin-top:15px}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #eee}
input[type=checkbox]{transform:scale(1.2);margin-left:10px}
.footer{text-align:center;margin-top:25px;font-size:14px;color:#777}
.progress{display:flex;gap:10px;margin-top:10px}
.kpi{flex:1;background:#fafafa;border:1px solid #eee;border-radius:10px;text-align:center;padding:10px}
.kpi .val{font-weight:700;font-size:18px}
.kpi .label{font-size:13px;color:#666}
.loading{display:none;text-align:center;font-weight:bold;color:#0b806a}
</style>
</head>
<body>
<div class="container">
<h1>📋 نظام رصد الغياب</h1>

<div id="loading" class="loading">⏳ جاري التحميل...</div>

<label>اختر الصف:</label>
<select id="gradeSelect"></select>

<div style="margin-top:10px">
<textarea id="smsTemplate" rows="2" placeholder="نص الرسالة لولي الأمر (مثال: نحيطكم علمًا بغياب ابنكم اليوم. نأمل المتابعة.)"></textarea>
</div>

<div style="margin-top:8px">
<label>القناة:</label>
<select id="channel">
  <option value="sms">SMS</option>
  <option value="whatsapp">WhatsApp</option>
</select>
<label style="margin-right:10px"><input type="checkbox" id="autoNotify" checked> إرسال تلقائي بعد الحفظ</label>
</div>

<div class="list" id="studentList"></div>

<div class="progress">
  <div class="kpi"><div id="total" class="val">0</div><div class="label">إجمالي الطلبة</div></div>
  <div class="kpi"><div id="present" class="val">0</div><div class="label">الحضور</div></div>
  <div class="kpi"><div id="absent" class="val">0</div><div class="label">الغياب</div></div>
</div>

<div style="margin-top:20px;text-align:center">
  <button class="primary" onclick="save()">💾 حفظ الغياب</button>
  <button class="secondary" onclick="reload()">🔄 تحديث</button>
</div>

<div class="footer">© مدرسة محمد بن سليمان الغافري</div>
</div>

<script>
// رابط السكربت المنشور
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNHFPxIo9_2dTSBbg9-A94Utc5VOwGzPa9EjiUhtevoB2WPuPZ-a_hb5dFh4F_6-MK/exec";

let students = [];
let selected = new Set();

// تحميل الصفوف عند البداية
window.onload = async () => {
  toggleLoading(true);
  const data = await (await fetch(SCRIPT_URL + "?action=init")).json().catch(()=>null);
  toggleLoading(false);
  if (!data || !data.grades) return alert("حدث خطأ في تحميل البيانات");
  const sel = document.getElementById("gradeSelect");
  sel.innerHTML = "<option value=''>اختر الصف</option>" + data.grades.map(g=>`<option>${g}</option>`).join("");
  sel.onchange = loadStudents;
};

// تحميل الطلبة عند اختيار صف
async function loadStudents(){
  const grade = this.value;
  if (!grade) return;
  toggleLoading(true);
  const res = await (await fetch(SCRIPT_URL + "?action=students&grade=" + encodeURIComponent(grade))).json().catch(()=>null);
  toggleLoading(false);
  if (!res) return alert("تعذر تحميل الطلبة");
  students = res;
  renderList();
}

// عرض قائمة الطلبة
function renderList(){
  const list = document.getElementById("studentList");
  list.innerHTML = "";
  selected.clear();
  students.forEach((st, i)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<label><input type="checkbox" onchange="toggle(${i}, this.checked)"> ${st.name}</label><span style="font-size:13px;color:#666">${st.id||''}</span>`;
    list.appendChild(div);
  });
  updateStats();
}

function toggle(i, checked){
  if(checked) selected.add(i); else selected.delete(i);
  updateStats();
}

function updateStats(){
  const t = students.length, a = selected.size, p = t - a;
  document.getElementById("total").textContent = t;
  document.getElementById("present").textContent = p;
  document.getElementById("absent").textContent = a;
}

// حفظ الغياب
async function save(){
  const grade = document.getElementById("gradeSelect").value;
  if(!grade) return alert("اختر صفًا أولاً");
  const rows = Array.from(selected).map(i=>students[i].row);
  const body = document.getElementById("smsTemplate").value || "نحيطكم علمًا بغياب ابنكم اليوم. نأمل المتابعة.";
  const channel = document.getElementById("channel").value;
  const auto = document.getElementById("autoNotify").checked;
  toggleLoading(true);
  const res = await fetch(SCRIPT_URL + "?action=save",{
    method:"POST",
    body: JSON.stringify({grade,rows,body,channel,auto}),
    headers:{"Content-Type":"application/json"}
  }).then(r=>r.json()).catch(()=>null);
  toggleLoading(false);
  if(!res) return alert("حدث خطأ في الحفظ");
  alert(`تم حفظ الغياب: ${res.current?.absent||0} غائب`);
}

// تحديث الصفحة
function reload(){ location.reload(); }

// تحميل وإخفاء
function toggleLoading(show){ document.getElementById("loading").style.display = show?"block":"none"; }
</script>
</body>
</html>

