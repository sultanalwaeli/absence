<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>رصد الغياب - تطبيق الويب</title>
<style>
:root{ 
  --brand:#115e59; --brand2:#0b8a6a; --ink:#0b1220; --muted:#5b6577; --stroke:#e6e9ef; 
  --radius:16px; --bar:80px; --font-size:18px; --touch-target:44px;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:"Noto Naskh Arabic","Segoe UI",Tahoma,Arial,sans-serif;
  line-height:1.6;background:#0e1615;color:var(--ink);font-size:var(--font-size);
  -webkit-tap-highlight-color:transparent;
}
.container{max-width:100%;margin:0 auto;padding:12px 10px calc(var(--bar) + env(safe-area-inset-bottom) + 10px)}
.hero{
  border-radius:18px;color:#fff;padding:14px;
  background:linear-gradient(135deg,rgba(17,94,89,.95),rgba(11,138,106,.95));
  box-shadow:0 12px 30px rgba(0,0,0,.15);margin-bottom:12px;
}
.hero-inner{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap}
.badge{background:rgba(15,23,42,.9);color:#fff;border-radius:20px;padding:8px 12px;font-weight:700;font-size:14px;white-space:nowrap}
.stats-comparison{background:rgba(255,255,255,.1);border-radius:12px;padding:10px;margin-top:8px;font-size:13px;border:1px solid rgba(255,255,255,.2)}
.stats-comparison div{margin-bottom:4px}
.card{background:#fff;border:1px solid var(--stroke);border-radius:var(--radius);padding:12px;margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.grid2,.grid3{display:grid;gap:8px;margin-bottom:8px}
.grid3{grid-template-columns:1fr 1fr 1fr}
@media (max-width:768px){.grid3{grid-template-columns:1fr}:root{--font-size:16px}}
.select,.btn{
  padding:14px;border:2px solid var(--stroke);border-radius:14px;background:#fff;
  font:inherit;font-size:var(--font-size);min-height:var(--touch-target);width:100%;
}
.btn{border:none;font-weight:700;cursor:pointer;text-align:center;transition:all .2s ease}
.btn:disabled{opacity:.6;cursor:not-allowed}
.primary{color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand2))}
.secondary{background:#f8fafc;color:var(--ink)}
.danger{color:#fff;background:#dc2626}
.warning{color:#fff;background:linear-gradient(135deg,#f59e0b,#d97706)}
.sticky{
  position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:2px solid var(--stroke);
  padding:10px;display:flex;gap:8px;z-index:1000;box-shadow:0 -8px 20px rgba(0,0,0,.1);flex-wrap:wrap;justify-content:space-between
}
.actions-group{display:flex;gap:8px;flex-wrap:wrap;flex:1}
.actions-group .btn{flex:1;min-width:140px}
.name{font-weight:700;font-size:var(--font-size);flex:1}
.meta{color:#64748b;font-size:14px}
.toast{
  position:fixed;bottom:calc(var(--bar) + 80px);left:50%;transform:translateX(-50%);
  background:#0f172a;color:#fff;padding:16px 20px;border-radius:12px;display:none;z-index:1001;
  font-size:16px;max-width:90%;text-align:center;animation:toastSlide .3s ease-out;box-shadow:0 10px 25px rgba(0,0,0,.2)
}
@keyframes toastSlide{from{transform:translateX(-50%) translateY(100px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
.success-toast{background:linear-gradient(135deg,#10b981,#059669);animation:successToast .5s ease-out;font-weight:bold}
@keyframes successToast{0%{transform:translateX(-50%) scale(.8);opacity:0}50%{transform:translateX(-50%) scale(1.05)}100%{transform:translateX(-50%) scale(1);opacity:1}}
.list{max-height:50vh;overflow-y:auto;margin-top:8px;border:1px solid var(--stroke);border-radius:12px;transition:all .5s ease}
.item{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid #f1f5f9;transition:all .3s ease}
.item:last-child{border-bottom:none}
.item .tag{font-size:12px;border-radius:20px;padding:4px 8px;border:1px solid var(--stroke);color:#475569;white-space:nowrap}
input[type="checkbox"]{transform:scale(1.3);margin:0;accent-color:var(--brand)}
.status-list{display:flex;flex-wrap:wrap;gap:6px}
.pill{padding:8px 12px;border-radius:20px;border:2px solid var(--stroke);background:#fff;cursor:pointer;font-size:14px;transition:all .3s ease}
.pill.taken{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border-color:transparent;animation:pulse 2s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
.small{font-size:14px;color:#64748b;margin-top:6px}
@media (max-width:480px){.sticky{padding:8px}.actions-group{gap:6px}.actions-group .btn{min-width:120px;font-size:14px;padding:10px}}
.loading{opacity:.7;pointer-events:none}
.loading-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);
  display:flex;justify-content:center;align-items:center;z-index:2000;display:none
}
.loading-spinner{background:white;padding:30px;border-radius:16px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,.3);min-width:200px}
.spinner{border:4px solid #f3f3f3;border-top:4px solid var(--brand);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:40px 20px;color:#64748b;transition:all .5s ease;font-size:16px}
.empty-state.success{background:#f0fdf4;border:2px solid #bbf7d0;border-radius:12px;color:#15803d;animation:successMessage .6s ease-out;font-weight:bold}
@keyframes successMessage{0%{transform:scale(.9);opacity:0}50%{transform:scale(1.02)}100%{transform:scale(1);opacity:1}}
.instructions{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:12px;margin-bottom:12px;font-size:14px;color:#0369a1}
.instructions ul{margin:8px 0;padding-right:20px}
.instructions li{margin-bottom:4px}
.comparison-card{background:linear-gradient(135deg,#fef7ed,#fffbeb);border:2px solid #fed7aa;border-radius:var(--radius);padding:12px;margin-bottom:10px}
.comparison-title{font-weight:700;color:#ea580c;margin-bottom:8px;font-size:16px}
.comparison-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px}
.stat-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #fed7aa}
.stat-label{color:#57534e}
.stat-value{font-weight:700}
.diff-positive{color:#16a34a}.diff-negative{color:#dc2626}.diff-zero{color:#6b7280}
.confetti{position:fixed;width:10px;height:10px;background:#ffd700;border-radius:50%;animation:confetti-fall 3s ease-in-out forwards;z-index:1002}
@keyframes confetti-fall{0%{transform:translateY(-100px) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
.password-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:3000;display:none}
.password-content{background:white;padding:30px;border-radius:20px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,.3);min-width:300px;max-width:90%}
.password-content h3{margin:0 0 20px 0;color:#dc2626;font-size:20px}
.password-input{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;font-size:18px;text-align:center;margin-bottom:15px;font-family:monospace;letter-spacing:2px}
.password-input:focus{border-color:#dc2626;outline:none}
.password-buttons{display:flex;gap:10px}
.password-buttons button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
.password-confirm{background:#dc2626;color:white}
.password-cancel{background:#6b7280;color:white}
.grade-actions{display:flex;gap:8px;margin-top:10px}
.grade-actions .btn{flex:1}
</style>
</head>
<body>
<div class="container">
  <!-- شريط التحميل -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <div>جاري تحميل البيانات...</div>
    </div>
  </div>

  <!-- نافذة الرمز السري -->
  <div id="passwordModal" class="password-modal">
    <div class="password-content">
      <h3>🔒 تفريغ الوسوم</h3>
      <p>أدخل الرمز السري للمتابعة:</p>
      <input type="password" id="passwordInput" class="password-input" placeholder="أدخل الرمز" maxlength="8" autocomplete="one-time-code">
      <div class="password-buttons">
        <button class="password-cancel" onclick="closePasswordModal()">إلغاء</button>
        <button class="password-confirm" onclick="confirmClearMarks()">تأكيد</button>
      </div>
    </div>
  </div>

  <div class="hero">
    <div class="hero-inner">
      <div style="flex:1;min-width:200px">
        <div style="font-weight:700;font-size:20px;margin-bottom:6px">رصد الغياب</div>
        <div style="opacity:.9;font-size:14px">اختر الصف من “متابعة الصفوف”، ثم حدّد الغائبين واحفظ</div>
      </div>
      <div style="text-align:left">
        <span class="badge" id="statsBadge">جاري التحميل...</span>
        <div id="statsComparison" class="stats-comparison" style="display:none">
          <div id="comparisonText"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- بطاقة المقارنة -->
  <div id="comparisonCard" class="comparison-card" style="display:none">
    <div class="comparison-title">📊 مقارنة الإحصاءات</div>
    <div class="comparison-stats">
      <div class="stat-item"><span class="stat-label">الحصة الأولى:</span><span class="stat-value" id="morningAbsent">0 غائب</span></div>
      <div class="stat-item"><span class="stat-label">الحالة الطارئة:</span><span class="stat-value" id="emergencyAbsent">0 غائب</span></div>
      <div class="stat-item"><span class="stat-label">الفرق:</span><span class="stat-value" id="differenceAbsent">0</span></div>
      <div class="stat-item"><span class="stat-label">الحالة:</span><span class="stat-value" id="differenceStatus">-</span></div>
    </div>
  </div>

  <!-- تعليمات -->
  <div class="instructions">
    <strong>طريقة الاستخدام:</strong>
    <ul>
      <li>اختر الصف من “متابعة الصفوف”.</li>
      <li>حدّد الطلاب الغائبين بمربعات الاختيار.</li>
      <li>اضغط “💾 حفظ الغياب المحدد” أو “🔄 إعادة التسجيل”.</li>
      <li>زر “عرض الغائبين” أسفل الشاشة يعرض جميع الغائبين لكل الصفوف.</li>
    </ul>
  </div>

  <!-- متابعة الصفوف -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px;font-size:16px">متابعة الصفوف</div>
    <div id="statusList" class="status-list"></div>
    <div class="small">اللون الأخضر يعني تم تسجيل الغياب للصف</div>
  </div>

  <div class="card">
    <div class="grid3">
      <!-- الإبقاء على وضع الرصد -->
      <select id="mode" class="select">
        <option value="الحصة الأولى">الحصة الأولى</option>
        <option value="حالة طارئة">حالة طارئة</option>
      </select>
      <!-- زر عرض الغائبين للجميع -->
      <div>
        <button class="btn secondary" id="showAbsentsBtn" type="button" style="width:100%">عرض الغائبين</button>
      </div>
      <!-- خانة ثالثة فارغة للمحافظة على الشبكة -->
      <div></div>
    </div>

    <!-- أزرار خاصة بالصف -->
    <div id="gradeActions" class="grade-actions" style="display:none">
      <button class="btn primary" id="saveBulkBtn" type="button">💾 حفظ الغياب المحدد</button>
      <button class="btn warning" id="redoBtn" type="button">🔄 إعادة التسجيل</button>
    </div>

    <!-- قائمة الطلاب -->
    <div id="list" class="list" style="display:none"></div>
    <div id="empty" class="empty-state">اختر الصف لتحميل الأسماء...</div>

    <!-- لوحة الغائبين -->
    <div id="absentsBox" class="card" style="margin-top:12px;display:none">
      <div style="font-weight:700">الغائبون (<span id="absCount">0</span>)</div>
      <div id="absContent" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- الشريط السفلي: تفريغ الوسوم + عرض الغائبين -->
<div class="sticky">
  <div class="actions-group">
    <button class="btn danger" id="clearMarksBtn" type="button">🗑️ تفريغ الوسوم</button>
    <button class="btn secondary" id="showAbsentsBtnFooter" type="button">👀 عرض الغائبين</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// ====== إعداد API ======
const API_URL = 'https://script.google.com/macros/s/AKfycbyNqFhY9RFxhW1joUSJ1as7PbDHCVAxpteZ0dmlBFuQf8llWU_XAu5KQMIjAu1nzPod/exec';

// طلب POST مبسّط (x-www-form-urlencoded) لتفادي CORS المعقد
async function apiCall(action, payload = {}) {
  const body = new URLSearchParams({
    action,
    data: JSON.stringify(payload)
  });
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
    body
  });
  // GAS قد يعيد JSON أو نص؛ نحاول القراءة بأمان
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, error:text }; }
}

// ====== أدوات واجهة ======
const qs = s => document.querySelector(s);
let CURRENT_LIST = [];
let SELECTED_ROWS = new Set();
let CURRENT_GRADE = '';

// مؤثرات
function playSuccessSound(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const g=ctx.createGain();
    osc.connect(g);g.connect(ctx.destination);
    osc.frequency.setValueAtTime(800,ctx.currentTime);
    osc.frequency.setValueAtTime(1000,ctx.currentTime+.1);
    osc.frequency.setValueAtTime(1200,ctx.currentTime+.2);
    g.gain.setValueAtTime(.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.3);
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+.3);
  }catch(e){}
}
function createConfetti(){
  try{
    const colors=['#ffd700','#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#feca57'];
    for(let i=0;i<20;i++){
      const c=document.createElement('div');
      c.className='confetti';
      c.style.left=Math.random()*100+'vw';
      c.style.background=colors[Math.floor(Math.random()*colors.length)];
      c.style.animationDelay=Math.random()*1+'s';
      c.style.width='8px';c.style.height='8px';
      document.body.appendChild(c);
      setTimeout(()=>c.remove(),3000);
    }
  }catch(e){}
}
const showToast=(msg,isSuccess=false)=>{
  const t=qs('#toast'); if(!t) return;
  t.textContent=msg;t.className=isSuccess?'toast success-toast':'toast';t.style.display='block';
  t.style.animation='none';setTimeout(()=>{t.style.animation=''},10);
  if(isSuccess){playSuccessSound();createConfetti();}
  setTimeout(()=>{t.style.display='none'},3000);
};

// تحميل
function showLoading(message='جاري تحميل البيانات...'){
  const ov=qs('#loadingOverlay');
  ov.querySelector('.loading-spinner div:last-child').textContent=message;
  ov.style.display='flex';document.body.classList.add('loading');
}
function hideLoading(){qs('#loadingOverlay').style.display='none';document.body.classList.remove('loading')}

// مقارنة وإحصاءات
function updateBadge(data){
  if(!data) return;
  const cur=data.current||data;
  const t=cur.total??0, a=cur.absent??0, p=cur.present??(t-a);
  qs('#statsBadge').textContent=`${data.mode||'-'} | الإجمالي: ${t} | غائب: ${a} | حاضر: ${p}`;
  updateComparison(data);
  if(data.statuses) renderStatuses(data.statuses);
}
function updateComparison(data){
  const card=qs('#comparisonCard');const comp=qs('#statsComparison');
  if(data.morning&&data.emergency){
    const m=data.morning.absent||0, e=data.emergency.absent||0, diff=m-e;
    qs('#morningAbsent').textContent=`${m} غائب`;
    qs('#emergencyAbsent').textContent=`${e} غائب`;
    qs('#differenceAbsent').textContent=Math.abs(diff);
    qs('#differenceAbsent').className=`stat-value ${diff>0?'diff-positive':diff<0?'diff-negative':'diff-zero'}`;
    let st='-';
    if(diff>0){st=`زيادة ${diff} في الحصة الأولى`;qs('#differenceStatus').className='stat-value diff-positive'}
    else if(diff<0){st=`زيادة ${Math.abs(diff)} في الحالة الطارئة`;qs('#differenceStatus').className='stat-value diff-negative'}
    else {st='متماثل';qs('#differenceStatus').className='stat-value diff-zero'}
    qs('#differenceStatus').textContent=st;
    card.style.display='block';
    qs('#comparisonText').textContent=data.comparison?.summary||
      `الحصة الأولى: ${m} غائب | الحالة الطارئة: ${e} غائب | الفرق: ${diff}`;
    comp.style.display='block';
  }
}

// متابعة الصفوف
function renderStatuses(statuses){
  const box=qs('#statusList'); box.innerHTML='';
  (statuses||[]).forEach(st=>{
    const pill=document.createElement('div');
    pill.className='pill'+(st.taken?' taken':'');
    pill.innerHTML=(st.taken?'✅ ':'⏳ ')+`<span>${st.grade}</span>`;
    pill.title=st.taken?'تم تسجيل الغياب لهذا الصف':'لم يتم التسجيل بعد';
    pill.addEventListener('click',()=> onGradeSelected(st.grade));
    box.appendChild(pill);
  });
}

async function onGradeSelected(grade){
  CURRENT_GRADE=grade;
  const actions=qs('#gradeActions'); if(actions){actions.style.display= grade? 'flex':'none'}
  if(!grade){
    qs('#list').style.display='none';
    qs('#empty').style.display='block';
    qs('#empty').textContent='اختر الصف لتحميل الأسماء...';
    qs('#empty').className='empty-state';
    return;
  }
  showLoading('جاري تحميل بيانات الصف...');
  qs('#empty').textContent='جاري تحميل الطلاب...'; qs('#empty').className='empty-state';

  // ensureBaselineOnGrade
  const res = await apiCall('ensureBaselineOnGrade',{ grade });
  if(!res || res.error){ showToast('❌ حدث خطأ في تحميل الصف'); hideLoading(); return; }
  updateBadge(res);
  await loadGradeListOnly();
  hideLoading();
}

async function loadGradeListOnly(){
  const grade=CURRENT_GRADE; if(!grade) return;
  showLoading('جاري تحميل قائمة الطلاب...');
  const list = await apiCall('getStudentsByGrade',{ grade });
  if(!Array.isArray(list)){ showToast('❌ خطأ في تحميل قائمة الطلاب'); hideLoading(); return; }
  CURRENT_LIST = list;
  SELECTED_ROWS.clear();
  renderList(); updateSelectionCount(); hideLoading();
}

function renderList(){
  const list=qs('#list'), empty=qs('#empty');
  if(!list||!empty) return;
  list.innerHTML='';
  if(!CURRENT_LIST.length){
    list.style.display='none';
    empty.style.display='block';
    empty.textContent='لا توجد نتائج';
    empty.className='empty-state';
    return;
  }
  empty.style.display='none'; list.style.display='block';

  CURRENT_LIST.forEach(st=>{
    const item=document.createElement('div'); item.className='item';
    const checkbox=document.createElement('input'); checkbox.type='checkbox';
    checkbox.checked=SELECTED_ROWS.has(st.row);
    checkbox.addEventListener('change',()=>{
      if(checkbox.checked){SELECTED_ROWS.add(st.row)} else {SELECTED_ROWS.delete(st.row)}
      updateSelectionCount();
    });
    const info=document.createElement('div'); info.style.flex='1';
    const name=document.createElement('div'); name.className='name'; name.textContent=st.name;
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`الصف: ${st.grade} - الرقم: ${st.id}`;
    info.appendChild(name); info.appendChild(meta);
    const tag=document.createElement('span'); tag.className='tag';
    tag.textContent=st.state==='غائب'?'غائب':'حاضر';
    tag.style.background=st.state==='غائب'?'#fee2e2':'#d1fae5';
    tag.style.color=st.state==='غائب'?'#dc2626':'#065f46';
    tag.style.borderColor=st.state==='غائب'?'#fecaca':'#a7f3d0';
    item.appendChild(checkbox); item.appendChild(info); item.appendChild(tag);
    list.appendChild(item);
  });
}

function updateSelectionCount(){
  const save=qs('#saveBulkBtn'); const redo=qs('#redoBtn');
  const count=SELECTED_ROWS.size;
  if(save) save.textContent= count>0? `💾 حفظ (${count} غائب)` : `💾 حفظ (الكل حاضر)`;
  if(redo) redo.textContent= count>0? `🔄 إعادة (${count} غائب)` : `🔄 إعادة (الكل حاضر)`;
}

// حفظ وإعادة
async function saveBulk(){
  const grade=CURRENT_GRADE; if(!grade){showToast('❌ اختر صفًا أولاً');return;}
  showLoading('جاري تسجيل الغياب...');
  const absentRows=[...SELECTED_ROWS];
  const res = await apiCall('smartMarkGrade',{ grade, absentRows });
  if(res?.ok){
    const msg= absentRows.length>0? `✅ تم التسجيل: ${res.presentCount||0} حاضر, ${res.absentCount||0} غائب`
                                  : `✅ تم تسجيل حضور للصف كاملاً (${res.presentCount||0} طالب)`;
    showToast(msg,true); updateBadge(res); fadeOutListAndReset();
  }else{
    showToast('❌ حدث خطأ في الحفظ: '+(res?.message||res?.error||'غير معروف'));
  }
  hideLoading();
}
async function redoAttendance(){
  const grade=CURRENT_GRADE; if(!grade){showToast('❌ اختر صفًا أولاً');return;}
  if(!confirm('⚠️ هل تريد إعادة تسجيل الغياب لهذا الصف؟ سيتم مسح التسجيلات السابقة.')) return;
  showLoading('جاري إعادة التسجيل...');
  const absentRows=[...SELECTED_ROWS];
  const res = await apiCall('redoGradeAttendance',{ grade, absentRows });
  if(res?.ok){
    const msg= absentRows.length>0? `✅ تم إعادة التسجيل: ${res.presentCount||0} حاضر, ${res.absentCount||0} غائب`
                                  : `✅ تم إعادة تسجيل حضور للصف كاملاً (${res.presentCount||0} طالب)`;
    showToast(msg,true); updateBadge(res); fadeOutListAndReset();
  }else{
    showToast('❌ حدث خطأ في إعادة التسجيل: '+(res?.message||res?.error||'غير معروف'));
  }
  hideLoading();
}

function fadeOutListAndReset(){
  const list=qs('#list'), empty=qs('#empty');
  if(list){
    list.style.opacity='0'; list.style.transform='translateY(-20px)'; list.style.transition='all .5s ease';
    setTimeout(()=>{
      list.style.display='none';
      if(empty){
        empty.style.display='block';
        empty.textContent='✅ تم الحفظ بنجاح! اختر صفًا آخر';
        empty.className='empty-state success';
      }
      SELECTED_ROWS.clear();
      CURRENT_LIST=[];
      updateSelectionCount();
    },500);
  }
}

// عرض الغائبين — دائمًا للجميع
async function showAbsentsAll(){
  showLoading('جاري تحميل قائمة الغائبين...');
  const res = await apiCall('listAbsentsAll',{});
  const box=qs('#absentsBox'); const content=qs('#absContent');
  content.innerHTML='';
  const total=res?.total??0; qs('#absCount').textContent=total;
  if(total===0){content.textContent='لا يوجد غياب في جميع الصفوف.'; box.style.display='block'; hideLoading(); return;}
  (res?.byGrade||[]).forEach(g=>{
    const h=document.createElement('div'); h.style.fontWeight='700'; h.style.marginTop='12px'; h.textContent=`${g.grade} — (${g.count})`;
    content.appendChild(h);
    const ul=document.createElement('ul'); ul.style.paddingRight='20px'; ul.style.marginTop='6px';
    g.names.forEach(s=>{
      const li=document.createElement('li'); li.textContent=`${s.name} — رقم: ${s.id||'-'}`; li.style.marginBottom='4px'; ul.appendChild(li);
    });
    content.appendChild(ul);
  });
  box.style.display='block'; hideLoading();
}

// نافذة الرمز السري
function openPasswordModal(){const m=qs('#passwordModal');const i=qs('#passwordInput');if(m&&i){m.style.display='flex';i.value='';i.focus();}}
function closePasswordModal(){const m=qs('#passwordModal'); if(m){m.style.display='none';}}
async function confirmClearMarks(){
  const password=qs('#passwordInput').value;
  if(!password){showToast('❌ الرجاء إدخال الرمز السري');return;}
  showLoading('جاري التحقق من الرمز...');
  const check = await apiCall('verifyPassword',{ password });
  if(check?.ok){
    const res = await apiCall('clearAllMarks',{ password });
    if(res?.ok){
      updateBadge(res);
      qs('#list').style.display='none';
      qs('#empty').style.display='block';
      qs('#empty').textContent='اختر الصف لتحميل الأسماء...';
      qs('#empty').className='empty-state';
      qs('#gradeActions').style.display='none';
      SELECTED_ROWS.clear(); CURRENT_LIST=[];
      hideLoading(); closePasswordModal(); showToast('✅ تم مسح جميع الوسوم بنجاح',true);
    }else{
      hideLoading(); showToast('❌ '+(res?.message||res?.error||'فشل غير معروف'));
    }
  }else{
    hideLoading(); showToast('❌ الرمز السري غير صحيح');
  }
}

// تهيئة
document.addEventListener('DOMContentLoaded', async ()=>{
  showLoading('جاري تحميل التطبيق...');
  const data = await apiCall('getInitial',{});
  if(!data || data.error){ showToast('❌ خطأ في تحميل البيانات الأولية'); hideLoading(); return; }
  qs('#mode').value=data?.mode||'الحصة الأولى';
  renderStatuses(data?.statuses||[]);
  updateBadge(data);
  hideLoading();
});

// أحداث
qs('#mode').addEventListener('change', async e=>{
  showLoading('جاري تغيير وضع الرصد...');
  const res = await apiCall('setMode',{ mode:e.target.value });
  if(!res || res.error){ showToast('❌ حدث خطأ في تغيير الوضع'); hideLoading(); return; }
  updateBadge(res);
  if(CURRENT_GRADE){ await loadGradeListOnly(); }
  hideLoading();
});
qs('#saveBulkBtn').addEventListener('click', saveBulk);
qs('#redoBtn').addEventListener('click', redoAttendance);
qs('#showAbsentsBtn').addEventListener('click', showAbsentsAll);
qs('#showAbsentsBtnFooter').addEventListener('click', showAbsentsAll);
qs('#clearMarksBtn').addEventListener('click', openPasswordModal);
// Enter لتأكيد الرمز
document.addEventListener('keypress', e=>{ if(e.key==='Enter' && qs('#passwordModal').style.display==='flex'){ confirmClearMarks(); }});
</script>
</body>
</html>
