<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨</title>
<style>
body{font-family:"Noto Naskh Arabic",sans-serif;background:#f4f6f8;color:#222;margin:0;padding:20px}
.container{max-width:900px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px}
h1{text-align:center;color:#0b806a}
button,select,textarea{font-family:inherit;font-size:16px}
button{cursor:pointer;padding:10px 20px;border:none;border-radius:10px}
button.primary{background:#0b806a;color:#fff}
button.secondary{background:#eee}
textarea{width:100%;border:1px solid #ddd;border-radius:10px;padding:10px}
select{padding:10px;border-radius:8px;border:1px solid #ccc;width:100%}
.list{margin-top:15px}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #eee}
input[type=checkbox]{transform:scale(1.2);margin-left:10px}
.footer{text-align:center;margin-top:25px;font-size:14px;color:#777}
.progress{display:flex;gap:10px;margin-top:10px}
.kpi{flex:1;background:#fafafa;border:1px solid #eee;border-radius:10px;text-align:center;padding:10px}
.kpi .val{font-weight:700;font-size:18px}
.kpi .label{font-size:13px;color:#666}
.loading{display:none;text-align:center;font-weight:bold;color:#0b806a}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨</h1>

<div id="loading" class="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<label>Ø§Ø®ØªØ± Ø§Ù„ØµÙ:</label>
<select id="gradeSelect"></select>

<div style="margin-top:10px">
<textarea id="smsTemplate" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ù…Ø«Ø§Ù„: Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ù‹Ø§ Ø¨ØºÙŠØ§Ø¨ Ø§Ø¨Ù†ÙƒÙ… Ø§Ù„ÙŠÙˆÙ…. Ù†Ø£Ù…Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.)"></textarea>
</div>

<div style="margin-top:8px">
<label>Ø§Ù„Ù‚Ù†Ø§Ø©:</label>
<select id="channel">
  <option value="sms">SMS</option>
  <option value="whatsapp">WhatsApp</option>
</select>
<label style="margin-right:10px"><input type="checkbox" id="autoNotify" checked> Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸</label>
</div>

<div class="list" id="studentList"></div>

<div class="progress">
  <div class="kpi"><div id="total" class="val">0</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø©</div></div>
  <div class="kpi"><div id="present" class="val">0</div><div class="label">Ø§Ù„Ø­Ø¶ÙˆØ±</div></div>
  <div class="kpi"><div id="absent" class="val">0</div><div class="label">Ø§Ù„ØºÙŠØ§Ø¨</div></div>
</div>

<div style="margin-top:20px;text-align:center">
  <button class="primary" onclick="save()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨</button>
  <button class="secondary" onclick="reload()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
</div>

<div class="footer">Â© Ù…Ø¯Ø±Ø³Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ù„ØºØ§ÙØ±ÙŠ</div>
</div>

<script>
// Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNHFPxIo9_2dTSBbg9-A94Utc5VOwGzPa9EjiUhtevoB2WPuPZ-a_hb5dFh4F_6-MK/exec";

let students = [];
let selected = new Set();

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙˆÙ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
window.onload = async () => {
  toggleLoading(true);
  const data = await (await fetch(SCRIPT_URL + "?action=init")).json().catch(()=>null);
  toggleLoading(false);
  if (!data || !data.grades) return alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  const sel = document.getElementById("gradeSelect");
  sel.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>" + data.grades.map(g=>`<option>${g}</option>`).join("");
  sel.onchange = loadStudents;
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØµÙ
async function loadStudents(){
  const grade = this.value;
  if (!grade) return;
  toggleLoading(true);
  const res = await (await fetch(SCRIPT_URL + "?action=students&grade=" + encodeURIComponent(grade))).json().catch(()=>null);
  toggleLoading(false);
  if (!res) return alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø©");
  students = res;
  renderList();
}

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø©
function renderList(){
  const list = document.getElementById("studentList");
  list.innerHTML = "";
  selected.clear();
  students.forEach((st, i)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<label><input type="checkbox" onchange="toggle(${i}, this.checked)"> ${st.name}</label><span style="font-size:13px;color:#666">${st.id||''}</span>`;
    list.appendChild(div);
  });
  updateStats();
}

function toggle(i, checked){
  if(checked) selected.add(i); else selected.delete(i);
  updateStats();
}

function updateStats(){
  const t = students.length, a = selected.size, p = t - a;
  document.getElementById("total").textContent = t;
  document.getElementById("present").textContent = p;
  document.getElementById("absent").textContent = a;
}

// Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨
async function save(){
  const grade = document.getElementById("gradeSelect").value;
  if(!grade) return alert("Ø§Ø®ØªØ± ØµÙÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹");
  const rows = Array.from(selected).map(i=>students[i].row);
  const body = document.getElementById("smsTemplate").value || "Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ù‹Ø§ Ø¨ØºÙŠØ§Ø¨ Ø§Ø¨Ù†ÙƒÙ… Ø§Ù„ÙŠÙˆÙ…. Ù†Ø£Ù…Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.";
  const channel = document.getElementById("channel").value;
  const auto = document.getElementById("autoNotify").checked;
  toggleLoading(true);
  const res = await fetch(SCRIPT_URL + "?action=save",{
    method:"POST",
    body: JSON.stringify({grade,rows,body,channel,auto}),
    headers:{"Content-Type":"application/json"}
  }).then(r=>r.json()).catch(()=>null);
  toggleLoading(false);
  if(!res) return alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
  alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨: ${res.current?.absent||0} ØºØ§Ø¦Ø¨`);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
function reload(){ location.reload(); }

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø®ÙØ§Ø¡
function toggleLoading(show){ document.getElementById("loading").style.display = show?"block":"none"; }
</script>
</body>
</html>

